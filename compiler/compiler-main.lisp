(in-package :compiler)

(defparameter *function-datatype* nil)

;;; HXA-writing utilities

(let ((output-list ()))
  (defun output-list-reset()
    (setf output-list ()))

  (defun append-line (line)
    (setf output-list (cons line output-list)))

  (defun append-lines (lines)
    (mapcar (lambda (line)
	      (append-line line))
	    lines))

  (defun get-output-list ()
    (reverse output-list)))

;;; Other utilities

(defun branch-parts (parent branch child-func)
    (let* ((branch-values (token-value branch))
	   (part-b (second branch-values))
	   (part-b-result (funcall child-func part-b))
	   (type-a (token-datatype parent))
	   (type-b (token-datatype part-b))
	   (type-order (compare-types type-b type-a)))
      (values branch-values part-b-result type-a type-b type-order)))


;;; Macros

(defmacro pass-datatype (parent generator branch)
  "Run the branch through the supplied generator, then set the parent datatype to match the branch"
  `(let ((output (funcall ,generator ,branch)))
     (setf (token-datatype ,parent) (token-datatype ,branch))
     output))

(defmacro defun-level-head (name body-name child-func &optional (maximize-datatypes t))
  `(defun ,name (branch)
     (let ((values (token-value branch)))
       (format nil "狺ㄣ镱疳篌溽翎豉疱怛犷汨＇汨殪洵骢钽ㄦ轵篝鲠祯弩┅磲疸狎灬礅溽鲠祯濠痱镧ì怙澌钺礤怛犷汨鲠祯濠箦翩麸脲瞽溽翎豉疱怛犷汨ㄩ磲轫辁瀛溽翎豉疱磲溽翎豉疱麸脲瞽溽翎豉疱怛犷汨麸脲瞽溽翎豉疱鲠祯濠麸脲瞽溽翎豉疱鲠祯濠┅┅蝈篝鲠祯弩┅┅┅换清铄蜥糸铉蓉骝镯劣ㄤ彐躅珏铄蜥翦躅镳ㄢ蜥钽瑭戾舄è鲠祯弩麸脲瞽鲠祯怛犷汨┅ㄦ徙麸箦泔钿鲠祯弩┅ㄣ镱汜翦钺翦篝蜷铉疳篌溽翎豉疱怛犷汨＇珏铄蜥翦驷泗矧驷泗矧ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅躅镳铄玑糸镱ㄦ矧磲铋⑽徘唼ㄧ弭溽翎豉疱箝麸脲瞽溽翎豉疱怛犷汨┅┅躅镳祜玳汜飙铄玑糸镱⒃艺蜗躅镳忾赭轶瀛泔眇戾礤铘⑽显┅┅ㄤ彐躅珏铄蜥翦驷泗矧ㄢ蜥钽瑭戾è鲠祯弩麸脲瞽鲠祯怛犷汨┅ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅扉翦蜥飙轭戾舄è扉麸脲瞽鲠祯ㄦ轵篝鲠祯弩┅扉舡铛礤蜷疳蝮瀛轭翦珏扉舂┅ㄣ镱汜翦钺翦篝蜷铉ㄣ镱è扉舡铛礤蜷倍箦翩麸脲瞽溽翎豉疱怛犷汨ч铘穿⑻稍姓尤è扉舡铛礤蜷驳订箦翩麸脲瞽溽翎豉疱怛犷汨ч铘俯⑻稍姓尤吒è扉舡铛礤蜷窗苟箦翩麸脲瞽溽翎豉疱怛犷汨ч铘辈⑻稍姓尤弑è扉舡铛礤蜷兜党订箦翩麸脲瞽溽翎豉疱怛犷汨ч铘倍⑻稍姓尤弑┅扉┅换拣狎孱屮鹁ㄧ孱弪狒瀛屮痱弩箝镱ㄦ轵篝麸脲瞽鲠祯ㄦ轵篝鲠祯弩┅┅拣狎孱屮鹁疳篌溽翎豉疱怛犷汨＇珏铄蜥翦屮ㄦ轵篝麸脲瞽鲠祯ㄦ轵篝鲠祯弩┅┅减铒瓠屮鹁疳篌溽翎豉疱怛犷汨＇珏铄蜥翦躅镳ㄦ轵篝鲠祯弩┅┅┅ㄤ彐躅珏铄蜥翦翦蝽怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠豉疱豉疱猢ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦驷泗矧ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄩㄣ镯疳蝈豉疱豉疱豉疱岍ㄧ弭豉疱篦狃豉疱豉疱猢ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换驼淘尚塘迷上ㄢ轭镳眭祠轲扉汜糸镱箦翩麸脲瞽溽翎豉疱怛犷汨ㄡ滗溽翎豉疱箝弩豉疱豉疱猢戾è矧溴蝈洵豉疱矧溴颦溽翎豉疱箝弩豉疱豉疱猢┅ㄦ矧磲铋⑼仗赃徇ㄦ轵篝矧溴蝈洵豉疱螬箦泔钿矧溴蝈洵豉疱螬┅换纳稚由衔ㄢ轭镳溟鲩箝镱箦翩麸脲瞽溽翎豉疱怛犷汨磲溽翎豉疱豉疱豉疱猢⒛芍叽叽┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦翦蝽珏铄蜥翦翦蝽怙澌珏铄蜥翦驷泗矧ㄤ彐躅珏铄蜥翦屮瓠徜溟糸鲥怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠豉疱豉疱豉疱矧溴颟ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦翦蝽ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄩ豉疱矧溴ㄧ弭豉疱篦狃豉疱豉疱猢ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换聊纳陨衔ㄢ轭镳徜溟糸镱箦翩麸脲瞽溽翎豉疱怛犷汨ㄡ滗溽翎豉疱箝弩豉疱豉疱猢戾è矧溴蝈洵豉疱矧溴颦溽翎豉疱箝弩豉疱豉疱猢┅ㄦ矧磲铋⒘哪唼徇ㄦ轵篝矧溴蝈洵豉疱螬箦泔钿矧溴蝈洵豉疱螬┅换诱略伊迷上躅镳铄玑糸镱箦翩麸脲瞽溽翎豉疱怛犷汨磲溽翎豉疱豉疱豉疱猢戾è矧溴蝈洵豉疱矧溴颦溽翎豉疱箝弩豉疱豉疱猢┅ㄦ矧磲铋嵊章唼徇ㄩ豉疱矧溴ㄦ矧磲铋⑽徘唼ㄧ弭溽翎豉疱箝豉疱岍ㄦ轵篝矧溴蝈洵豉疱螬箦泔钿矧溴蝈洵豉疱螬┅┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦屮瓠徜溟糸鲥珏铄蜥翦屮瓠徜溟糸鲥怙澌珏铄蜥翦翦蝽ㄤ彐躅珏铄蜥翦屮瓠蝈灬糸镱犰怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠豉疱豉疱猢ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦屮瓠徜溟糸鲥箦翩麸脲瞽溽翎豉疱怛犷汨ч铘穿ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换膛佑匀廖ㄣ镯瓠祠ㄦ矧磲铋⒚托咛赃徇豉疱豉疱猢换且帕耘匀廖ㄣ镯瓠玺ㄦ矧磲铋⒚托咔赃狺豉疱豉疱猢换膛佑匀廖弦叛樟韵ㄣ镯瓠祠ㄦ矧磲铋⒚托咛耘唼狺豉疱豉疱猢换膛佑匀廖弦叛樟韵ㄣ镯瓠玺ㄦ矧磲铋⒚托咔耘唼狺豉疱豉疱猢┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦屮瓠蝈灬糸镱犰珏铄蜥翦屮瓠蝈灬糸镱犰怙澌珏铄蜥翦屮瓠徜溟糸鲥ㄤ彐躅珏铄蜥翦屮瓠羼踽扉豉怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠豉疱豉疱猢ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦屮瓠蝈灬糸镱犰箦翩麸脲瞽溽翎豉疱怛犷汨ч铘穿ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换叛樟韵ㄣ镯瓠祠ㄦ矧磲铋⒚托吲堰徇豉疱豉疱猢换蜗叛樟韵ㄣ镯瓠玺ㄦ矧磲铋⒚托呶叛唼狺豉疱豉疱猢┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦屮瓠羼踽扉豉珏铄蜥翦屮瓠羼踽扉豉怙澌珏铄蜥翦屮瓠蝈灬糸镱犰ㄤ彐躅珏铄蜥翦屮瓠祜玳汜飙犷洵怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦屮瓠羼踽扉豉箦翩麸脲瞽溽翎豉疱怛犷汨ч铘穿ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换滔巧昧廖祜玳汜飙犷ㄦ矧磲铋⒘文┅┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦屮瓠祜玳汜飙犷珏铄蜥翦屮瓠祜玳汜飙犷洵怙澌珏铄蜥翦屮瓠羼踽扉豉ㄤ彐躅珏铄蜥翦屮瓠怙澌疳蝈铘怛犷汨眭祠轲戾鲠祯瀛忾钿鲠祯弩疳螋猸蝈篚祠ㄢ蜥钽璀疳螋疳蝈铘怛犷汨＇珏铄蜥翦屮瓠祜玳汜飙犷洎箦翩麸脲瞽溽翎豉疱怛犷汨ч铘穿ㄣ镱汜翦钺翦篝蜷铉疳螋猸蝈篚祠ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅换滔巧昧弦祜玳汜飙矧ㄦ矧磲铋⑾┅┅┅ㄤ彐躅戾鲥飙桢徜珏铄蜥翦屮珏铄蜥翦屮瓠怙澌珏铄蜥翦屮瓠祜玳汜飙犷洎ㄤ彐躅珏铄蜥翦篝狒屙孱ㄢ蜥钽瑭戾è鲠祯弩麸脲瞽鲠祯怛犷汨┅ㄣ狍麸脲瞽豉疱ㄦ轵篝鲠祯弩┅脲蝈趱蝾戾è怛犷汨屮箦泔钿鲠祯弩┅扉篝ㄧ孱弪狒瀛屮怛犷汨屮皓ㄧ弭汜篝麸脲瞽溽翎豉疱怛犷汨屮皓骢钽糸镱溽翎豉疱┅┅┅ㄤ彐躅珏铄蜥翦骢钽糸镱ㄢ蜥钽瑭戾舄è鲠祯弩麸脲瞽鲠祯怛犷汨┅ㄦ躅豉疱ㄩ铘弪篝蜷铉躔汜箦麸脲瞽鲠祯ㄦ轵篝麸脲瞽鲠祯ㄦ轵篝鲠祯弩┅┅恒镯痖戾颟ㄦ躅殇麸脲瞽鲠祯箦泔钿鲠祯弩┅ㄦ躅篝狒屙孱趔ㄣ滗鲠祯弩┅箦翩骢钽糸镱溽翎豉疱骢瞽豉疱ㄡ痧孱洵扉铄ㄣ镱汜翦钺翦篝蜷铉⒗骢瞽殇┅磲疸灬礅溽篝狒屙孱舂ㄡ痧孱洵扉铄ㄧ孱弪狒瀛篝狒屙孱篝狒屙孱舂┅骢瞽篝狒屙孱趔ㄡ痧孱洵扉铄⒁旁┅ㄤ彐躅珏铄蜥翦ㄡ篝⑶孱弪狒矧孱趄零沐痿犷劣犷蝈趱蝾扉篝镦蓉眍屙镱殂螈秕麴豸扉篝蝈箦舂ㄩ弪蝻颦扉篝痱镧麒孱鲥蜮矬濯痱轭舡弪蝻颦扉篝弪蝻颦扉篝┅扉篝┅痱镧麒孱鲥蜮矬濯痱轭舡麸脲瞽趄邋狍舂ㄡ痧孱洵扉铄⒚撂卷衢睥ㄡ痧孱洵扉铄⑶显九文磲疸狎灬礅溽ㄢ蜥钽璀骢钽糸镱ㄧ孱弪狒瀛骢钽糸镱怛犷汨骢钽糸镱┅麸脲瞽鲠祯ㄣ狎狍舂┅ㄡ痧孱洵扉铄⒗盼蘑ㄧ弭秕麴豸扉篝┅┅ㄤ彐躅痱轭舡弪蝻颦扉篝ㄥ蝌矧扉篝ㄦ矧磲⒚贤猩塘陨衔乓蚁矣アㄦ矧磲⑻晌捎诱毗ア磲疸狎灬礅溽ㄥ戾舄è麸脲ㄣ徜徜濠扉铄铛礅弪麸脲瞽扉铄铛礅弪麸脲瞟ㄥ蝌矧豉疱ㄣ狎濠ㄥ疱泗邃豉疱ㄣ後潋濠ㄡ泗踽飙豉疱麸脲瞽豉疱麸脲瞟┅ㄦ矧磲朵砒疱泗邃岈顼狺ア扉铄铛礅弪弪蝻颦豉疱屮疱泗邃豉疱徙趱犰豉疱┅弪蝻颦扉篝┅换歪轭骢钽糸镱ㄤ彐躅秕麴豸狍箦礅禊ㄦ殪孱犴桫岍⒆蜷翦蓉眍屙镱殂狍翦骈戾鏖翳镳孱骈戾篝蝈犴骈戾钺礤轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴洪姝滹弩铒舡屮轶恒蝈狒濠磲疸狎灬礅溽扉铄黩轸瀛扉铄扉铄篝蝈犴┅桫岍┅换韵南泔铞弪翳轶麸狎蝻簌铘狲骘沆狎轸ㄤ彐躅泔眇殪瀛桫ㄦ殪孱犴瀛桫脲鲥蜮矬舂⑼衢孱趄骢钽糸镱义徜犷桫骈戾犷狒翦眇趔麸秕麴豸犷桫骈戾箦翩鲥蜮矬濯鲥蜮矬濠ㄣ戾狎弪蝻颦扉篝戾舄è疳翳溟鲩箫箦狎汨骈戾钺礤桫烘蝻憝孱舂ㄦ殪孱犴瀛篝蜷痧邃篚怏羼骈戾钺礤桫疳翳溟鲩箫箦狎汨桫恽骈戾钺礤桫悌┅ㄦ殪屦狒篚怏羼骈戾钺礤桫疳翳溟鲩箫颟秕麴豸骈戾钺礤ㄣ镱汜翦钺翦篝蜷铉骈戾疳翳骈戾钺礤篝蜷痧邃桫幄┅祜徜骈戾骈戾钺礤桫悌秕麴豸狍箦礅禊秕麴豸骈戾钺礤ㄧ孱弪狒疳蝮戾ㄧ弭蝈徜弪扉篝＇屙痿篝蜷铉＇泔眄孱舡篝蜷铉皓┅┅┅弪蝻颦扉篝